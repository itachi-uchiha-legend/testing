{
    "isUpdateAvailable": false,
    "isCustom": false,
    "isEnabled": false,
    "isRemoteConnector": false,
    "environment": "Default Environment",
    "integration": "Exchange",
    "identifier": "Exchange Mail Connector v2 with Oauth Authentication_91d40c46-c7d8-4240-a1e2-7adf3add1247",
    "connectorDefinitionName": "Exchange Mail Connector v2 with Oauth Authentication",
    "displayName": "Exchange Mail Connector v2 with Oauth Authentication",
    "description": "Connector can be used to monitor specific mailboxes on Office 365 mail servers that require Oauth authentication. Get Authorization and Generate Token actions can be used to obtain refresh token that should be set in the connector. Note: Make sure to configure the integration first for the Oauth authentication.",
    "runIntervalInSeconds": 10,
    "resultDataType": 0,
    "version": "1",
    "pythonVersion": 3,
    "isAllowlistSupported": true,
    "params": [
        {
            "connectorIdentifier": null,
            "paramName": "Environment Regex Pattern",
            "paramValue": "",
            "description": "A regex pattern to run on the value found in the \"Environment Field Name\" field. Default is .* to catch all and return value unchanged. Used to allow the user to manipulate the environment field via regex logic. If regex pattern is null or empty, or the environment value is null, the final environment result is \"\"",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Headers to add to events",
            "paramValue": "",
            "description": "Specify what headers from emails should be added to the events. Parameter accepts multiple values as a comma separated string. Provided values can be exact match or set as a regex.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Email exclude pattern",
            "paramValue": "",
            "description": "Regular expression to exclude specific emails from being ingested by the connector. Works with both subject and body part of email. Example is, to exclude mass mailing emails like news from being ingested.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Original Received Mail Prefix",
            "paramValue": "orig",
            "description": "Prefix to add to the extracted event keys (to, from,subject,\u2026) from the original email received in the monitored mailbox.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Attached Mail File Prefix",
            "paramValue": "attach",
            "description": "Prefix to add to the extracted event keys (to, from,subject,\u2026) from the attached mail file received with the email in the monitored mailbox.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Create a Separate Siemplify Alert per Attached Mail File?",
            "paramValue": "false",
            "description": "If enabled, connector will create multiple alerts, 1 alert per attached mail file. This behavior can be useful when processing email with multiple mail files attached and Siemplify event mapping set to create entities from attached mail file.",
            "type": 0,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Mail Server Address",
            "paramValue": "outlook.office365.com",
            "description": "Mail server IP address to connect to. If connecting to O365, server address should be set to outlook.office365.com",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": true,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Mail Address",
            "paramValue": "james.bond@siemplifycyarx.onmicrosoft.com",
            "description": "Mail address to use for connector.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": true,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Client ID",
            "paramValue": "93107771-ca33-4d31-8059-535c7481368a",
            "description": "For Office 365 Oauth authentication, Client (Application) ID of Azure Active Directory App that will be used for the integration.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": true,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Client Secret",
            "paramValue": "***************",
            "description": "For Office 365 Oauth authentication, secret can be provided for the auth flow.",
            "type": 3,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Tenant (Directory) ID",
            "paramValue": "d48f52ca-5b1a-4708-8ed0-ebb98a26a46a",
            "description": "For Office 365 Oauth authentication, Azure Tenant (Directory) ID.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": true,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Refresh Token",
            "paramValue": "***************",
            "description": "For Office 365 Oauth authentication, refresh token that was obtained from running \u201cGet Authorization\u201d and \u201cGenerate Token\u201d actions.",
            "type": 3,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": true,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Verify SSL",
            "paramValue": "false",
            "description": "If enabled, verify the SSL certificate for the connection to the Exchange server is valid.",
            "type": 0,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Folder to check for emails",
            "paramValue": "a9",
            "description": "Parameter can be used to specify email folder on the mailbox to search for the emails. Parameter should also accept comma separated list of folders to check the user response in multiple folders. Parameter is case sensitive. '/' separator can be used to specify a subfolder to search in, example: Inbox/Subfolder",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": true,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Unread Emails Only",
            "paramValue": "false",
            "description": "If checked, cases will be pulled only from unread emails",
            "type": 0,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Mark Emails as Read",
            "paramValue": "false",
            "description": "If checked, after the emails have been pulled they will be marked as read",
            "type": 0,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Use Delegated Access",
            "paramValue": "false",
            "description": "If enabled, delegated access type will be used. Otherwise, impersonation access type is used. For details on impersonation/delegation and EWS, see the following link https://learn.microsoft.com/en-us/exchange/client-developer/exchange-web-services/impersonation-and-ews-in-exchange.",
            "type": 0,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Offset Time In Days",
            "paramValue": "5",
            "description": "Number of days before the first connector iteration to retrieve mails from. This parameter applies to the initial connector iteration after you enable the connector for the first time, or used as a fallback value in cases where connector's last run timestamp expires.",
            "type": 1,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": true,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Fetch Backwards Time Interval (minutes)",
            "paramValue": "0",
            "description": "Time interval connector should use to fetch events from max hours backwards or connector last run timestamp. This parameter in minutes can be used to split max hours backwards on smaller segments and process them individually. Its recommended to adjust this value accordingly to the environment, for example 60 minutes or less.",
            "type": 1,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Max Emails Per Cycle",
            "paramValue": "10",
            "description": "Fetch x emails per connector cycle",
            "type": 1,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": true,
            "isAdvanced": false,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Proxy Server Address",
            "paramValue": "http://0.0.0.0:8866/",
            "description": "The address of the proxy server to use.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Proxy Username",
            "paramValue": "",
            "description": "The proxy username to authenticate with.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Proxy Password",
            "paramValue": "",
            "description": "The proxy password to authenticate with.",
            "type": 3,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Extract urls from HTML email part?",
            "paramValue": "false",
            "description": "Specify whether connector should additionally try to extract urls from html part of email. This will allow connector to extract complex urls, but urls from plain text part of email will not be extracted with this method. Extracted urls will be available in urls_from_html_part event field.",
            "type": 0,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Disable Overflow",
            "paramValue": "false",
            "description": "If enabled, the connector will ignore the overflow mechanism.",
            "type": 0,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Environment Field Name",
            "paramValue": "",
            "description": "Describes the name of the field where the environment name is stored. If the environment field isn't found, the environment is the default environment.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Script Timeout (Seconds)",
            "paramValue": "60",
            "description": "Timeout limit for the python process running the current script.",
            "type": 1,
            "mode": 0,
            "isDisplayed": true,
            "isMandatory": true,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Attach Original EML",
            "paramValue": "false",
            "description": "If checked, the original email will be attached to the case info as an eml file",
            "type": 0,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Case Name Template",
            "paramValue": "",
            "description": "When provided, connector will add a new key called \"custom_case_name\" to the Siemplify Event. It can used to have a customer case name. Please refer to the documentation portal for more details. You can provide placeholders in the following format: [name of the field]. Example: Phishing - [event_mailbox]. Note: connector will use first Siemplify Event for placeholders. Only keys that have string value will be handled.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Alert Name Template",
            "paramValue": "",
            "description": "If provided, connector will use this value for Siemplify Alert Name. Please refer to the documentation portal for more details. You can provide placeholders in the following format: [name of the field]. Example: Phishing - [event_mailbox]. Note: connector will use first Siemplify Event for placeholders. Only keys that have string value will be handled. If nothing is provided or user provides an invalid template, connector will use the default alert name.",
            "type": 2,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Email Padding Period (minutes)",
            "paramValue": "0",
            "description": "Specify an optional time period in minutes connector should fetch emails for prior to the latest timestamp.",
            "type": 1,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Base64 Encoded Private Key",
            "paramValue": "",
            "description": "Specify a base64 encoded private key that will be used to decrypt the email.",
            "type": 3,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Base64 Encoded Certificate",
            "paramValue": "",
            "description": "Specify a base64 encoded certificate that will be used to decrypt the email.",
            "type": 3,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        },
        {
            "connectorIdentifier": null,
            "paramName": "Base64 Encoded CA certificate",
            "paramValue": "",
            "description": "Specify a base64 encoded trusted CA certificate for signature verification.",
            "type": 3,
            "mode": 2,
            "isDisplayed": true,
            "isMandatory": false,
            "isAdvanced": true,
            "id": 0,
            "creationTimeUnixTimeInMs": 0,
            "modificationTimeUnixTimeInMs": 0
        }
    ],
    "allowList": [
        "subject: (?<=Subject: ).*",
        "to: (?m)(?<=^To: ).*"
    ],
    "integrationVersion": 107.0,
    "isScriptConnector": true,
    "script": "import sys\nimport pytz\n\nfrom Siemplify import Siemplify\nfrom SiemplifyUtils import output_handler, utc_now\nfrom SiemplifyConnectors import SiemplifyConnectorExecution\nfrom ExchangeManager import ExchangeManager\nfrom ExchangeCommon import ExchangeCommon\nfrom ExchangeConnectors import set_proxy, filter_emails_with_regexes, ExchangeConnector\nfrom EmailUtils import EmailUtils\nfrom TIPCommon import extract_connector_param, read_ids, write_ids\nfrom ExchangeUtilsManager import (\n    is_invalid_prefix,\n    convert_comma_separated_to_list,\n    save_file_in_temp_folder,\n)\nfrom exceptions import InvalidParameterException, SMIMEMailError\nfrom constants import (\n    STORED_IDS_LIMIT,\n    DECRYPT_PRIVATE_KEY_FILE_PATH,\n    DECRYPT_KEY_CERTIFICATE_FILE_PATH,\n    DECRYPT_CA_CERTIFICATE_FILE_PATH,\n)\n\n# =====================================\n#              CONSTANTS              #\n# =====================================\nCONNECTOR_NAME = \"Exchange EML Connector v2 with Oauth Authentication\"\nDEFAULT_DIVIDER = \",\"\nconnector_starting_time = utc_now().replace(tzinfo=pytz.UTC)\n\n\n@output_handler\ndef main(test_run):\n    cases = []\n    connector_scope = SiemplifyConnectorExecution()\n    connector_scope.script_name = CONNECTOR_NAME\n    chronicle_soar = Siemplify()\n\n    if test_run:\n        connector_scope.LOGGER.info(\n            '***** This is an \"IDE Play Button\"\\\\\"Run Connector once\" test run ******'\n        )\n\n    connector_scope.LOGGER.info(\n        \"-------------------- Main - Param Init --------------------\"\n    )\n\n    environment_field_name = extract_connector_param(\n        connector_scope, param_name=\"Environment Field Name\"\n    )\n    environment_regex = extract_connector_param(\n        connector_scope, param_name=\"Environment Regex Pattern\"\n    )\n    headers_to_add_to_events = extract_connector_param(\n        connector_scope, param_name=\"Headers to add to events\"\n    )\n    headers_to_add_to_events = (\n        [\n            header.strip()\n            for header in headers_to_add_to_events.split(DEFAULT_DIVIDER)\n            if header and header.strip()\n        ]\n        if headers_to_add_to_events\n        else []\n    )\n    email_exclude_pattern = extract_connector_param(\n        connector_scope, param_name=\"Email exclude pattern\"\n    )\n    mail_server_address = extract_connector_param(\n        connector_scope, param_name=\"Mail Server Address\", is_mandatory=True\n    )\n    mail_address = extract_connector_param(\n        connector_scope, param_name=\"Mail Address\", is_mandatory=True\n    )\n    client_id = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Client ID\", is_mandatory=True\n    )\n    client_secret = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Client Secret\", is_mandatory=False\n    )\n    tenant_id = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Tenant (Directory) ID\", is_mandatory=True\n    )\n    refresh_token = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Refresh Token\", is_mandatory=True\n    )\n    folder_name = extract_connector_param(\n        connector_scope, param_name=\"Folder to check for emails\", is_mandatory=True\n    )\n    unread_only = extract_connector_param(\n        connector_scope, param_name=\"Unread Emails Only\", input_type=bool\n    )\n    mark_as_read = extract_connector_param(\n        connector_scope, param_name=\"Mark Emails as Read\", input_type=bool\n    )\n    use_delegated_access = extract_connector_param(\n        siemplify=connector_scope,\n        param_name=\"Use Delegated Access\",\n        is_mandatory=False,\n        input_type=bool,\n        default_value=False,\n        print_value=True,\n    )\n    attach_original_eml = extract_connector_param(\n        connector_scope, param_name=\"Attach Original EML\", input_type=bool\n    )\n    offset_time_in_days = extract_connector_param(\n        connector_scope,\n        param_name=\"Offset Time In Days\",\n        input_type=int,\n        is_mandatory=True,\n    )\n    time_interval = extract_connector_param(\n        connector_scope,\n        param_name=\"Fetch Backwards Time Interval (minutes)\",\n        input_type=int,\n        default_value=0,\n    )\n    padding_period = extract_connector_param(\n        connector_scope, param_name=\"Email Padding Period (minutes)\", input_type=int\n    )\n    max_email_per_cycle = extract_connector_param(\n        connector_scope,\n        param_name=\"Max Emails Per Cycle\",\n        input_type=int,\n        is_mandatory=True,\n    )\n    extract_html_content_urls = extract_connector_param(\n        siemplify=connector_scope,\n        param_name=\"Extract urls from HTML email part?\",\n        input_type=bool,\n    )\n    disable_overflow = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Disable Overflow\", input_type=bool\n    )\n    verify_ssl = extract_connector_param(\n        siemplify=connector_scope,\n        param_name=\"Verify SSL\",\n        input_type=bool,\n        default_value=False,\n    )\n\n    original_mail_prefix = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Original Received Mail Prefix\"\n    )\n    attached_mail_prefix = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Attached Mail File Prefix\"\n    )\n    alert_per_attachment = extract_connector_param(\n        siemplify=connector_scope,\n        param_name=\"Create a Separate Siemplify \" \"Alert per Attached Mail File?\",\n        input_type=bool,\n    )\n    case_name_template = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Case Name Template\"\n    )\n    alert_name_template = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Alert Name Template\"\n    )\n    base64_private_key = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Base64 Encoded Private Key\"\n    )\n    base64_certificate = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Base64 Encoded Certificate\"\n    )\n    base64_ca_certificate = extract_connector_param(\n        siemplify=connector_scope, param_name=\"Base64 Encoded CA certificate\"\n    )\n    folder_names = convert_comma_separated_to_list(folder_name)\n\n    set_proxy(connector_scope)\n\n    connector_scope.LOGGER.info(\n        \"------------------- Main - Started -------------------\"\n    )\n\n    try:\n        if original_mail_prefix and is_invalid_prefix(original_mail_prefix):\n            raise InvalidParameterException(\n                \"Original Received Mail Prefix configured contains a space, \"\n                \"which is not supported, please remove any spaces and try again.\"\n            )\n\n        if attached_mail_prefix and is_invalid_prefix(attached_mail_prefix):\n            raise InvalidParameterException(\n                \"Attached Mail File Prefix configured contains a space, which is not \"\n                \"supported, please remove any spaces and try again.\"\n            )\n\n        if padding_period is not None and padding_period < 0:\n            raise InvalidParameterException(\n                '\"Email Padding Period (minutes)\" must be non-negative'\n            )\n\n        private_key_path, certificate_path, ca_certificate_path = None, None, None\n\n        if base64_private_key:\n            private_key_path = save_file_in_temp_folder(\n                chronicle_soar, base64_private_key, DECRYPT_PRIVATE_KEY_FILE_PATH\n            )\n        if base64_certificate:\n            certificate_path = save_file_in_temp_folder(\n                chronicle_soar,\n                base64_certificate,\n                DECRYPT_KEY_CERTIFICATE_FILE_PATH\n            )\n        if base64_ca_certificate:\n            ca_certificate_path = save_file_in_temp_folder(\n                chronicle_soar, base64_ca_certificate, DECRYPT_CA_CERTIFICATE_FILE_PATH\n            )\n\n        connector_scope.LOGGER.info(\"Connecting to Exchange.\")\n        email_client = ExchangeManager(\n            exchange_server_ip=mail_server_address,\n            domain=None,\n            user_mail_address=mail_address,\n            siemplify_logger=connector_scope.LOGGER,\n            client_id=client_id,\n            client_secret=client_secret,\n            tenant_id=tenant_id,\n            auth_token=refresh_token,\n            use_delegated_access=use_delegated_access,\n            verify_ssl=verify_ssl,\n        )\n        exchange_common = ExchangeCommon(connector_scope.LOGGER, email_client)\n        email_utils = EmailUtils(logger=connector_scope.LOGGER)\n        exchange_connector = ExchangeConnector(\n            connector_scope,\n            email_client,\n            exchange_common,\n            email_utils,\n            offset_time_in_days,\n            environment_field_name,\n            environment_regex,\n            test_run,\n            headers_to_add_to_events,\n            extract_html_content_urls=extract_html_content_urls,\n            time_interval=time_interval,\n            connector_starting_time=connector_starting_time,\n            case_name_template=case_name_template,\n            alert_name_template=alert_name_template,\n            padding_period=padding_period,\n        )\n\n        # Read already existing alerts ids\n        existing_ids = read_ids(connector_scope)\n        connector_scope.LOGGER.info(\n            f\"Successfully loaded {len(existing_ids)} existing ids\"\n        )\n\n        emails = exchange_connector.get_new_emails(\n            unread_only,\n            folder_names,\n            existing_ids,\n            mail_address,\n        )\n        # get oldest max_email_per_cycle emails\n        emails = emails[-max_email_per_cycle:]\n\n        if mark_as_read and not test_run:\n            exchange_connector.mark_emails_as_read(emails)\n        elif mark_as_read:\n            connector_scope.LOGGER.info(\n                \"This is a TEST run. Email won't be marked as read\"\n            )\n\n        emails = filter_emails_with_regexes(\n            emails, email_exclude_pattern, email_exclude_pattern\n        )\n\n        connector_scope.LOGGER.info(\n            f\"Number of emails after filtering by regexes {len(emails)}\"\n        )\n\n        if test_run:\n            emails = emails[:1]\n            connector_scope.LOGGER.info(\n                \"Trimmed number of emails for processing to 1, since it's a test run\"\n            )\n\n        connector_scope.LOGGER.info(\"Fetching emails according to timestamp.\")\n\n        for original_msg in emails:\n            try:\n                connector_scope.LOGGER.info(\n                    f\"Running on email with ID: {original_msg.message_id}\"\n                )\n\n                if not alert_per_attachment:\n                    cases_list = [\n                        exchange_connector.create_case_from_message(\n                            original_msg,\n                            attach_original_eml,\n                            original_mail_prefix,\n                            attached_mail_prefix,\n                            private_key_path=private_key_path,\n                            certificate_path=certificate_path,\n                            ca_certificate_path=ca_certificate_path,\n                            temp_folder_path=chronicle_soar.get_temp_folder_path(),\n                        )\n                    ]\n                else:\n                    cases_list = exchange_connector.create_cases_from_message(\n                        original_msg,\n                        attach_original_eml,\n                        original_mail_prefix,\n                        attached_mail_prefix,\n                        private_key_path=private_key_path,\n                        certificate_path=certificate_path,\n                        ca_certificate_path=ca_certificate_path,\n                        temp_folder_path=chronicle_soar.get_temp_folder_path(),\n                    )\n\n                # Update existing alerts\n                existing_ids.append(original_msg.message_id)\n\n                for case in cases_list:\n                    if (\n                        disable_overflow\n                        or not exchange_connector.is_original_case_info_overflow(case)\n                    ):\n                        cases.append(case)\n\n            except SMIMEMailError as e:\n                existing_ids.append(original_msg.message_id)\n                connector_scope.LOGGER.error(\n                    f\"Failed to process SMIME email with \"\n                    f\"message_id={original_msg.message_id}. Skipping. Error: {str(e)}\"\n                )\n            except Exception as e:\n                connector_scope.LOGGER.error(\n                    f\"Failed to process email with message_id={original_msg.message_id}\"\n                )\n\n                connector_scope.LOGGER.exception(e)\n                if test_run:\n                    raise\n\n        if not test_run:\n            connector_scope.LOGGER.info(\"Saving existing ids.\")\n            write_ids(connector_scope, existing_ids, stored_ids_limit=STORED_IDS_LIMIT)\n            exchange_connector.save_timestamp(emails, time_interval)\n\n        connector_scope.LOGGER.info(f\"Created {len(cases)} cases.\")\n\n    except InvalidParameterException as error:\n        connector_scope.LOGGER.error(error)\n        if test_run:\n            raise error\n\n        raise\n\n    except Exception as error:\n        connector_scope.LOGGER.error(\"Error in main handler\")\n        connector_scope.LOGGER.exception(error)\n        if test_run:\n            raise error\n\n        raise\n\n    connector_scope.LOGGER.info(\n        \"------------------- Main - Finished -------------------\"\n    )\n    connector_scope.return_package(cases)\n\n\nif __name__ == \"__main__\":\n    # Connectors are run in iterations. The interval is configurable from the ConnectorsScreen UI.\n    is_test = not (len(sys.argv) < 2 or sys.argv[1] == \"True\")\n    main(is_test)\n",
    "documentationLink": "https://cloud.google.com/chronicle/docs/soar/marketplace-integrations/exchange#exchange_mail_connector_v2_with_oauth_authentication",
    "deviceProductField": "device_product",
    "eventNameField": "event_name",
    "connectorStatus": null,
    "isNew": false,
    "agentIdentifier": null
}